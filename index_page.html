<!DOCTYPE html>
<html>
<head>
    <title>Uber Trip Data</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- <link href="slider.css" rel="stylesheet" type="text/css" />  -->
    <!-- 可选的 Bootstrap 主题文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-1.9.1.min.js" integrity="sha256-wS9gmOZBqsqWxgIVgA8Y9WcQOa7PgSIX+rPA0VL2rbQ=" crossorigin="anonymous"></script>

    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>
    <script src="https://kit.fontawesome.com/afa3fff295.js" crossorigin="anonymous"></script>
   
    <style>
        /* 移除 body 的固定 padding，改由 container 控制 */
        body { 
            padding: 0; 
            margin: 0; 
            background-color: #f5f5f5; 
        }
        /* 這是內容容器，在手機上間距變小，大螢幕變大 */
        .main-container {padding: 15px;}
        @media (min-width: 768px) {.main-container { padding: 30px 50px; }}

        /* 讓 Banner 容器黑底，確保圖片沒填滿時不露白 */
        .banner-wrapper {
            background-color: black;
            width: 100%;
            overflow: hidden;
            text-align: center;
        }

        /* 讓 Banner 圖片能隨螢幕寬度縮放 */
        .banner-img {
            width: 100%;
            max-width: 1200px;  /* 限制最大寬度，避免在大螢幕過度拉伸 */
            height: 250px;
            object-fit: contain;     /* 關鍵：等比例縮放填滿，不壓扁 */
            margin: 0 auto;
            display: block;
        }

        /* 強制功能列容器字體正常，避免繼承 36px */
        .filter-row {
            margin-top: 30px;
            padding: 0 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;    /* 垂直居中 */
            justify-content: center; /* 水平居中 */
            font-size: 14px;         /* 重設正常字體大小 */
        }
    
        /* 讓 col 區塊在 Flex 模式下不要亂跑 */
        .filter-item {
            margin-bottom: 15px;
            padding: 0 10px;
            display: flex;
            align-items: center;
        }

        /* 手機版響應式：螢幕窄時，高度可以縮小一點，才不會佔滿整個手機畫面 */
        @media (max-width: 768px) {
            .banner-img {
                height: 150px;
            }
        }

        /* 讓表格在手機上可以橫向滑動，不會撐破版面 */
        .table-responsive {
            border: none;
            margin-top: 20px;
        }
        i{cursor: pointer;}

        /* --- 導覽列縮減樣式 --- */

        /* 1. 調整導覽列整體最小高度 (原本預設是 50px) */
        .navbar {
            min-height: 40px !important;
        }

        /* 2. 縮小左側 "My Uber" 的字體與邊距 */
        .navbar-brand {
            font-size: 14px !important;    /* 縮小字體 */
            padding: 10px 15px !important; /* 縮減上下內邊距 (10px) */
            height: 40px !important;       /* 配合 navbar 高度 */
        }

        /* 3. 縮小 "DATASET" 選單的字體與邊距 */
        .navbar-nav > li > a {
            font-size: 13px !important;    /* 縮小字體 */
            padding-top: 10px !important;    /* 縮減上方間距 */
            padding-bottom: 10px !important; /* 縮減下方間距 */
        }

        /* 4. 修正右側搜尋框的位置，讓它在變窄的導覽列中垂直置中 */
        .navbar-form {
            margin-top: 3px !important;
            margin-bottom: 3px !important;
        }
        
        .navbar-form .form-control {
            height: 30px; /* 搜尋框也稍微變矮一點點才協調 */
        }
        
        .navbar-form .btn {
            padding: 4px 10px; /* 搜尋按鈕也稍微縮小 */
        }

        /* 1. 強制讓表格標題內的文字和箭頭圖示永遠排在同一行 */
        th {
            white-space: nowrap !important; /* 確保不換行 */
            vertical-align: middle !important;
            padding: 15px 10px !important;   /* 增加一點寬度空間 */
            background-color: #eee;         /* 給標題一個淺灰色底，更有表格層次感 */
        }
        
        /* 2. 讓箭頭緊隨文字，避免被擠壓 */
        th i {
            font-size: 18px !important;    /* 放大箭頭，原本可能只有 10-12px */
            margin-left: 6px !important;   /* 增加文字與箭頭間的距離 */
            color: #333;                   /* 讓顏色深一點，看起來更清晰 */
            display: inline-block !important;
            vertical-align: middle !important;
            transition: transform 0.2s;    /* 增加一點點平滑動畫效果 */
        }
        /* 當滑鼠移上去時變色，增加互動感 */
        th i:hover {
            color: #337ab7;                /* 變成 Bootstrap 的藍色 */
            transform: scale(1.2);         /* 滑鼠移上去再放大 20%，增加點擊反饋 */
        }
                
        /* 3. 修正表格容器，確保小螢幕可滑動但不擠壓內容 */
        .table-responsive {
            width: 100%;
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }
        
        /* 4. 給表格一個最小寬度，防止 8 個欄位擠在一起 */
        #result {
            min-width: 1000px !important; 
            table-layout: auto !important;
        }

        /* 固定每一欄的最小寬度，防止 Reset 時數據長短造成表格跳動 */
        #result th:nth-child(1), 
        #result td:nth-child(1) { 
            min-width: 70px !important;    /* 增加寬度到 80px，確保三位數也放得下 */
            white-space: nowrap !important; /* 強制禁止換行，這是解決 2-6-1 變垂直的關鍵 */
            text-align: center !important; 
            padding: 10px 5px !important;  /* 稍微縮減內邊距，把空間留給數字 */
        }     /* 序號欄 */
        #result th:nth-child(2) { min-width: 160px; }      /* START DATE */
        #result th:nth-child(3) { min-width: 180px; }      /* DURATION */
        #result th:nth-child(4) { min-width: 120px; }      /* CATEGORY */
        #result th:nth-child(5) { min-width: 180px; }      /* START LOCATION */
        #result th:nth-child(6) { min-width: 180px; }      /* END LOCATION */
        #result th:nth-child(7) { min-width: 150px; }      /* MILES */
        #result th:nth-child(8) { min-width: 180px; }      /* PURPOSE */
        
        /* 確保內容如果太長會自動換行，不會撐開欄位 */
        #result td {
            word-break: break-word;
            vertical-align: middle !important;
        }
    </style>

    <!-- 引入 ECharts 文件 -->
    <script src="echarts.min.js"></script>

</head>

<body data-target="#navbar-spy" data-spy="scroll">
    <header>
        <nav class="navbar navbar-inverse navbar-fixed-top" id="navbar-spy">
            <!-- Logo-->
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#">MY UBER</a>
                </div>
                <!-- 選單內容 -->
                <div>
                    <ul class="nav navbar-nav">
                        <li><a data-toggle="tab" href="#menu1">TRIP LOGS</a></li>
                    </ul>
                </div>
                <!-- 引入 GOOGLE SEARCH -->
                <script>
                    var domainroot="http://www.google.com"  //Enter domain of site to search.
                    function Gsitesearch(curobj){ curobj.q.value = curobj.qfront.value } 
                </script> 
                <form class="search navbar-form navbar-right" action="https://www.google.com/search" method="get" role="search" target="_blank" onSubmit="Gsitesearch(this)"> 
                    <div class="input-group"> <input name="q" type="hidden" /> 
                        <input class="form-control" name="qfront" type="search" required class="searchField" placeholder="Search Google" maxlength="50"/> 
                        <span class="input-group-btn"> <button type="submit" class="search-button btn btn-primary"> <span class="glyphicon glyphicon-search"></span> </button> </span> 
                    </div> 
                </form>
                <!-- GOOGLE SEARCH END -->
            </div>
        </nav> 
    </header>

    <!-- Dataset Area -->
    <div class="tab-content">
        <div id="menu1" class="tab-pane fade in active">
            <div style="background: black; overflow: hidden;">
                <img src="uber_pic.png" class="banner-img" alt="Uber Trip Banner">
            </div>
            <div style="width: 80%; margin: 0 auto;">
                <div class="row" style="margin-top: 30px; padding: 0 15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: center;">
                
                    <div class="col-md-2 col-xs-12" style="margin-bottom: 15px;">
                        <button type="button" class="btn btn-default btn-block" onclick="default_()" style="height: 34px;">Reset</button>
                    </div>
    
                    <div class="col-md-4 col-xs-12" style="margin-bottom: 15px;">
                        <div class="dropdown">
                            <button class="btn btn-primary dropdown-toggle btn-block" type="button" data-toggle="dropdown" style="height: 34px;">
                                <span id="selected_purpose_text">Select Purpose</span>
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" id="purpose_list" style="width: 100%; max-height: 300px; overflow-y: auto;">
                                <li><a href="javascript:void(0)" onclick="selectPurpose('')">-- All Purposes --</a></li>
                                <li role="separator" class="divider"></li>
                            </ul>
                            <input type="hidden" id="search_item_2" value="">
                        </div>
                    </div>
    
                    <div class="col-md-4 col-xs-12" style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 5px; height: 34px;">
                            <input id="small_" type="number" class="form-control" style="width: 80px; height: 34px;" value="0">
                            <span style="font-size: 18px; line-height: 1;">~</span>
                            <input id="big_" type="number" class="form-control" style="width: 80px; height: 34px;" value="500">
                            <button class="btn btn-info" type="button" onclick="range_()" style="height: 34px;">Miles Filter</button>
                        </div>
                    </div>
                </div>
            </div>

            <table id="result" class ="table table-bordered" style="margin-top: 3%;width:80%;font-size:16px;margin-left:auto;margin-right:auto;">
            <thead>
                <tr>
                    <th> </th>
                    <!-- <th>sequence <i class="fas fa-caret-square-down" onclick=""></i><i class="fas fa-caret-square-up" onclick=""></i></th> -->
                    <th>START DATE <i class="fas fa-caret-square-down" onclick="startdate_sort_down()"></i><i class="fas fa-caret-square-up" onclick="startdate_sort_up()"></i></th>
                    <th>DURATION (Min) <i class="fas fa-caret-square-down" onclick="duration_sort_down()"></i><i class="fas fa-caret-square-up" onclick="duration_sort_up()"></i></th>
                    <th>CATEGORY <i class="fas fa-caret-square-down" onclick="catalog_sort_down()"></i><i class="fas fa-caret-square-up" onclick="catalog_sort_up()"></i></th>
                    <th>START LOCATION <i class="fas fa-caret-square-down" onclick="start_sort_down()"></i><i class="fas fa-caret-square-up" onclick="start_sort_up()"></i></th>
                    <th>END LOCATION <i class="fas fa-caret-square-down" onclick="destination_sort_down()"></i><i class="fas fa-caret-square-up" onclick="destination_sort_up()"></i></th>
                    <th>MILES <i class="fas fa-caret-square-down" onclick="mile_sort_down()"></i><i class="fas fa-caret-square-up" onclick="mile_sort_up()"></i></th>
                    <th>PURPOSE <i class="fas fa-caret-square-down"onclick="purpose_sort_down()"></i><i class="fas fa-caret-square-up" onclick="purpose_sort_up()"></i></th>   
                </tr>
                <!-- visual -->
                <tr>
                    <!-- SLIDER -->
                    <th>
                        <!-- <button class="btn btn-default" type="submit" onclick="slider_()">%</button>
                        <div id='volume' class='slider' > 
                            <div class='slider-track'>
                                <div class='slider-thumb'>100</div>
                                <div class='slider-level'></div>
                            </div>
                            <input class='slider-input' type='range' value='100' min='0' max='100' />
                        </div> -->
                        <script>
                            "use strict";
                            function Slider(slider){
                            this.slider = slider;
                            var sldinput= this.slider.querySelector('.slider-input');//input
                            var sldthumb= this.slider.querySelector('.slider-thumb');//中间按钮
                            var sldlevel= this.slider.querySelector('.slider-level');//当前值显示的进度
                            this.slider.addEventListener('input', function() {
                                    this.updateSliderLevel();
                                }.bind(this), false);
                            
                            this.updateSliderLevel =function() {
                                var val=parseInt(sldinput.value);
                                sldthumb.style.left = val + '%';//更新按钮的位置
                                sldthumb.textContent = val;   //更新近钮上显示的值
                                sldlevel.style.width = val + '%';//更新进度条的长度
                            }
                            }
                            var volumeSlider =document.getElementById('volume');
                            new Slider(volumeSlider);

                            function slider_(){
                                var volumn = 0;
                                volumn = document.querySelector('#volume .slider-input').value;
                                var num=0;
                                if(volumn != 0){num = Math.round(1155*(volumn*0.01));}
                            if(num == 0){
                                var srearchItem = "HELLO"
                                var purpose_ = database.ref('/index').orderByChild('PURPOSE').equalTo(srearchItem);
                                var djson;

                                purpose_.once('value', function(snapshot){
                                    djson_ = JSON.parse(JSON.stringify(snapshot.val()));
                                    djson = jsonToArray(djson_)
                                    
                                    var tr = "";
                                    var i = 1;
                                    for(x in djson){
                                        if(djson[x] != null){
                                            tr += "<tr>";
                                            tr += "<td>"+i+"</td>";
                                            tr += "<td>"+djson[x]["START_DATE"]+"</td>";
                                            tr += "<td>"+getDuration(djson[x]["START_DATE"], djson[x]["END_DATE"])+"</td>"; // 改這行
                                            tr += "<td>"+djson[x]["CATEGORY"]+"</td>";
                                            tr += "<td>"+djson[x]["START"]+"</td>";
                                            tr += "<td>"+djson[x]["STOP"]+"</td>";
                                            tr += "<td>"+djson[x]["MILES"]+"</td>";
                                            tr += "<td>"+djson[x]["PURPOSE"]+"</td>";
                                            tr += "</tr>";
                                            i ++; 
                                        }    
                                    }
                                    document.querySelector("table tbody").innerHTML = tr;
                                });
                            }
                            else {
                                var prec_ = database.ref('/index').orderByChild('MILES').limitToFirst(num);
                                prec_.once('value', function(snapshot){
                                    var djson_raw = snapshot.val();
                                    var djson = jsonToArray(djson_raw);
                                    
                                    var tr = "";
                                    var i = 1;
                                    for(x in djson){
                                        if(djson[x] != null){
                                            tr += "<tr>";
                                            tr += "<td>"+i+"</td>";
                                            tr += "<td>"+djson[x]["START_DATE"]+"</td>";
                                            tr += "<td>"+getDuration(djson[x]["START_DATE"], djson[x]["END_DATE"])+"</td>";
                                            tr += "<td>"+djson[x]["CATEGORY"]+"</td>";
                                            tr += "<td>"+djson[x]["START"]+"</td>";
                                            tr += "<td>"+djson[x]["STOP"]+"</td>";
                                            tr += "<td>"+djson[x]["MILES"]+"</td>";
                                            tr += "<td>"+djson[x]["PURPOSE"]+"</td>";
                                            tr += "</tr>";
                                            i ++; 
                                        }    
                                    }
                                    document.querySelector("table tbody").innerHTML = tr;
                                });  
                            }
                        }
                        </script>
                    </th>
                    <!-- start date -->
                    <th style="width: 160px; height: 160px; padding: 0; position: relative;">
                        <div id="main" style="width: 160px; height: 160px;"></div>
                        <script type="text/javascript">
                            var myChart = echarts.init(document.getElementById('main'));
                            var rawData = [
                                [0, 6, 33, '#AED6F1'],
                                [6, 9, 52, '#85C1E9'],
                                [9, 12, 188, '#5DADE2'],
                                [12, 14, 171, '#3498DB'],
                                [14, 18, 370, '#2E86C1'],
                                [18, 21, 233, '#21618C'],
                                [21, 24, 108, '#1B4F72']
                            ];

                            // 找出數據最大值，用來設定半徑軸的上限，確保不會爆框
                            var maxVal = Math.max(...rawData.map(d => d[2]));
                                
                            var totalTrips = 1155; 
                            // var timeData = [33, 52, 188, 171, 370, 233, 108];
                            // var timeLabels = ['0-6', '6-9', '9-12', '12-14', '14-18', '18-21', '21-24'];
                                
                           var option = {
                                grid: { top: 0, left: 0, right: 0, bottom: 0 },
                                graphic: [
                                    {
                                        type: 'group',
                                        left: 'center',
                                        top: 'center',
                                        children: [
                                            {
                                                type: 'circle',
                                                shape: { r: 12 },
                                                style: { fill: '#fff', stroke: '#555', lineWidth: 1 }
                                            },
                                            {
                                                type: 'path',
                                                shape: { d: 'M 0 0 L 0 -7 M 0 0 L 4 0' },
                                                style: { stroke: '#555', lineWidth: 1.2 },
                                                x: 0, y: 0
                                            }
                                        ]
                                    }
                                ],
                                polar: {
                                    radius: ['25%', '75%'], 
                                    center: ['50%', '50%'] // 強制居中
                                },
                                angleAxis: {
                                    type: 'value',
                                    min: 0,
                                    max: 24,
                                    startAngle: 90,
                                    clockwise: true,
                                    splitNumber: 24, // 產生 24 條背景線
                                    axisLine: { show: false },
                                    axisTick: { show: false },
                                    splitLine: { lineStyle: { color: '#f0f0f0', type: 'solid' } }, // 繪製背景分割線
                                    axisLabel: {
                                        formatter: (v) => [0, 6, 12, 18].includes(v) ? (v < 10 ? '0' + v : v) : '',
                                        margin: 5,
                                        fontSize: 9
                                    }
                                },
                                radiusAxis: {
                                    type: 'value',
                                    min: 0,
                                    max: maxVal + 20, // 重要：手動設定最大值，防止扇形撐破容器
                                    axisLine: { show: false },
                                    axisLabel: { show: false },
                                    splitLine: { show: false }
                                },
                                series: [{
                                    type: 'custom',
                                    coordinateSystem: 'polar',
                                    renderItem: function (params, api) {
                                        var values = rawData[params.dataIndex];
                                        var startHour = values[0];
                                        var endHour = values[1];
                                        var val = values[2];
                                        
                                        // 將時間轉換為座標系統需要的徑向和角度
                                        // coord: [角度值, 半徑值]
                                        var start = api.coord([startHour, val]);
                                        var end = api.coord([endHour, val]);
                                        
                                        // 計算內圓半徑和外圓半徑
                                        var r0 = params.coordSys.r0; // polar 設定的內徑 25%
                                        var r = api.coord([0, val])[0]; // 根據數據計算的外徑
                                        
                                        return {
                                            type: 'sector', // 繪製扇形
                                            shape: {
                                                cx: params.coordSys.cx,
                                                cy: params.coordSys.cy,
                                                r0: r0,
                                                r: r,
                                                // ECharts 的角度是弧度制，且 0 度在右側水平線，需轉換
                                                startAngle: (90 - startHour * 15) * Math.PI / 180,
                                                endAngle: (90 - endHour * 15) * Math.PI / 180,
                                                clockwise: true
                                            },
                                            style: {
                                                fill: values[3],
                                                stroke: '#fff',
                                                lineWidth: 1
                                            }
                                        };
                                    },
                                    data: rawData.map(d => d[2]) // 傳入數值供 api.coord 使用
                                }]
                            };
                            myChart.setOption(option);
                        </script>
                    </th>
                    <!--1 DURATION -->
                    <th style="position: relative; width: 160px; height: 180px; padding: 0; vertical-align: top;">
                            <div id="main1" style="width: 100%; height: 100%;"></div>
                            <script type="text/javascript">
                                var myChart1 = echarts.init(document.getElementById('main1'));
                                var totalTrips = 1155;
                                var durationValues = [55, 215, 215, 203, 135, 88, 107, 57, 26, 18, 6, 30];
                                var binNames = [
                                    '[0, 5)', '[5, 10)', '[10, 15)', '[15, 20)', '[20, 25)', '[25, 30)', 
                                    '[30, 40)', '[40, 50)', '[50, 60)', '[60, 80)', '[80, 100)', '[100, ∞)'
                                ];
                                var option1 = {
                                    tooltip: {
                                        trigger: 'axis',
                                        backgroundColor: 'rgba(50, 50, 50, 0.8)',
                                        textStyle: { color: '#fff', fontSize: 11},
                                        axisPointer: { type: 'none' }, // 使用陰影指示器更像直方圖
                                        confine: true,
                                        formatter: function(params) {
                                            var p = params[0];
                                            var percent = ((p.value / totalTrips) * 100).toFixed(2) + '%';
                                            return p.name + ': ' + p.value + ' (' + percent + ')';
                                        }
                                    },
                                    grid: { 
                                        top: 15, 
                                        bottom:20, 
                                        left: 7, 
                                        right: 0,
                                        containLabel: false 
                                    },
                                    xAxis: {
                                        type: 'category',
                                        data: binNames,
                                        boundaryGap: true, // 關鍵：讓數據點（Bar 的左側）直接對齊刻度
                                        axisLine: { show: true, lineStyle: { color: '#eee' } }, 
                                        axisTick: { 
                                            show: true, 
                                            alignWithLabel: false, // 讓線出現在 Bar 與 Bar 之間
                                            length: 4,            // 線的長度
                                            lineStyle: { color: '#999', width: 1 } // 細黑色線
                                        },
                                        axisLabel: { 
                                            fontSize: 8, 
                                            interval: 0,
                                            color: '#666',
                                            align: 'right',
                                            margin: 4,
                                            padding: [0, 2, 0, 0],
                                            formatter: function (value, index) {
                                                var labels = ['0', '5', '', '15', '', '25', '', '40', '', '60', '', '100', ''];
                                                return labels[index];
                                            }
                                        },
                                    },
                                    yAxis: { show: false},
                                    series: [{
                                        type: 'bar',
                                        data: durationValues,
                                        barWidth: '100%',
                                        customValues: durationValues,
                                        itemStyle: { color: '#37A2DA', borderWidth: 0.5, borderRadius: 0, borderWidth: 0.5, borderColor: '#fff'},
                                        emphasis: {disabled: false, scale: false, itemStyle: {color: '#2a82b3'}}
                                    }]
                                };
                                myChart1.setOption(option1);
                            </script>
                        </th>
                    <!--2 catalogy -->
                    <th>
                        <div id="main2" style="width: 120px; height: 120px; margin: 0 auto;"></div>
                        <script type="text/javascript">
                            var myChart2 = echarts.init(document.getElementById('main2'));
                            var option2 = {
                                title: {},
                                tooltip: {
                                    trigger: 'item',
                                    formatter: '{b}: {c} ({d}%)' // 滑鼠移上去時顯示詳細數據
                                },
                                legend: {show: false},
                                grid: {top: 0,bottom: 0,left: 0,right: 0},
                                xAxis: {show: false},
                                yAxis: {show: false},
                                series: [{
                                    name: 'Category',
                                    type: 'pie',
                                    center: ['50%', '50%'],
                                    radius: ['55%', '80%'], 
                                    avoidLabelOverlap: false,
                                    label: {show: false},
                                    labelLine: {show: false},
                                    emphasis: {
                                        scale: true, 
                                        scaleSize: 5,
                                        label: {show: false}
                                    },
                                    data: [
                                        {value: 1078, name: 'Business'},
                                        {value: 77, name: 'Personal'}
                                    ]
                                }]
                            };
                            myChart2.setOption(option2);
                        </script>
                    </th>
                    <!-- 3 start -->
                    <th style="position: relative; width: 160px; height: 80px; padding: 0; vertical-align: top;">
                            <div id="main3" style="width: 100%; height: 100%;"></div>
                            <div id="unknown-info" style="
                                position: absolute; 
                                bottom: 10px; 
                                width: 100%; 
                                text-align: left; 
                                padding-left: 20px;
                                font-size: 10px; 
                                color: #999; 
                                pointer-events: none;
                                line-height: 12px;">
                            </div>
                            <script type="text/javascript">
                                var myChart3 = echarts.init(document.getElementById('main3'));

                                var rawNames = ["Cary", "Unknown Location", "Morrisville", "Whitebridge", "Islamabad", "Durham", "Lahore", "Raleigh", "Karachi", "Apex", "Berkeley"];
                                var rawValues = [201, 148, 85, 68, 57, 37, 36, 28, 27, 17, 16];
                                var total = 1155; // 這裡手動設定為你資料集的總行數
                                
                                // 2. 計算比例
                                var unknownIdx = rawNames.indexOf("Unknown Location");
                                var unknownValue = unknownIdx > -1 ? rawValues[unknownIdx] : 0;
                                var unknownPercent = ((unknownValue / total) * 100).toFixed(1) + '%';

                                // 【關鍵修改：把文字塞進 HTML 標籤】
                                document.getElementById('unknown-info').innerText = 'Unknown: ' + unknownValue + ' (' + unknownPercent + ')';
                                
                                // 3. 過濾 Unknown 並取前 10
                                var filtered = [];
                                rawNames.forEach((name, i) => {
                                    if (name !== "Unknown Location") filtered.push({name: name, value: rawValues[i]});
                                });
                                var top10 = filtered.slice(0, 10).reverse(); // 反轉讓第一名在最上面
                                
                                var option3 = {
                                    tooltip: { 
                                        trigger: 'axis',
                                        backgroundColor: 'rgba(50, 50, 50, 0.8)',
                                        textStyle: { color: '#fff', fontSize: 11 },
                                        axisPointer: { type: 'none' },
                                        formatter: function(params) {
                                            var val = params[0].value;
                                            var percent = ((val / total) * 100).toFixed(2) + '%';
                                            return params[0].name + ': ' + val + ' (' + percent + ')';
                                        }
                                    },
                                    grid: {
                                        top: 0,      // 徹底壓縮留白
                                        bottom: 15,  // 僅留底部給 Unknown 文字
                                        left: 20,     // 柱子直接貼到最左邊
                                        right: 10,    // 貼到最右邊
                                        containLabel: false // 關閉標籤佔位
                                    },
                                    xAxis: { show: false, type: 'value' },
                                    yAxis: {
                                        type: 'category',
                                        data: [10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
                                        axisLine: { show: false }, // 隱藏軸線
                                        axisTick: { show: false }, // 隱藏刻度
                                        axisLabel: { show: true, interval: 0, color: '#666', fontSize: 8, margin: 5}
                                    },
                                    series: [{
                                        type: 'bar',
                                        data: top10.map(item => ({name: item.name, value: item.value})),
                                        barWidth: '85%', // 加粗柱子，減少垂直空隙
                                        itemStyle: { 
                                            color: '#37A2DA', 
                                            borderRadius: [0, 2, 2, 0] 
                                        },
                                        label: {show: false},
                                        emphasis: {
                                            itemStyle: { 
                                                disabled: false,
                                                scale: false,
                                                color: '#2a82b3' } // 移上去時稍微改變顏色亮度即可，不需要灰色背景
                                        }
                                    }]
                                };
                            myChart3.setOption(option3);
                            </script>
                    </th>
                    <!--4 end location -->
                    <th style="position: relative; width: 160px; height: 80px; padding: 0; vertical-align: top;">
                        <div id="main4" style="width: 100%; height: 100%;"></div>
                        <div id="unknown-info-end" style="
                            position: absolute; 
                            bottom: 10px; 
                            width: 100%; 
                            text-align: left; 
                            padding-left: 20px;
                            font-size: 10px; 
                            color: #999; 
                            pointer-events: none;
                            line-height: 12px;">
                        </div>
                        
                        <script type="text/javascript">
                            var myChart4 = echarts.init(document.getElementById('main4'));
                            // 原始數據
                            var rawNamesEnd = ["Cary","Unknown Location","Morrisville","Whitebridge","Islamabad","Durham","Lahore","Raleigh","Karachi","Apex", "Berkeley"];
                            var rawValuesEnd = [203, 149, 84, 65, 58, 36, 35, 29, 26, 17, 16]; // 這裡稍微修正了你的原始數據格式
                            var total = 1155; 
                    
                            // 1. 處理 Unknown 資訊
                            var unkIdxEnd = rawNamesEnd.indexOf("Unknown Location");
                            var unkValEnd = unkIdxEnd > -1 ? rawValuesEnd[unkIdxEnd] : 0;
                            var unkPctEnd = ((unkValEnd / total) * 100).toFixed(1) + '%';
                            document.getElementById('unknown-info-end').innerText = 'Unknown: ' + unkValEnd + ' (' + unkPctEnd + ')';
                    
                            // 2. 過濾並取前 10 (由小到大排，讓最大在上面)
                            var filteredEnd = [];
                            rawNamesEnd.forEach((name, i) => {
                                if (name !== "Unknown Location") filteredEnd.push({name: name, value: rawValuesEnd[i]});
                            });
                            var top10End = filteredEnd.slice(0, 10).reverse();
                    
                            var option4 = {
                                tooltip: { 
                                    trigger: 'axis',
                                    backgroundColor: 'rgba(50, 50, 50, 0.8)',
                                    textStyle: { color: '#fff', fontSize: 11 },
                                    axisPointer: { type: 'none' },
                                    formatter: function(params) {
                                        var val = params[0].value;
                                        var percent = ((val / total) * 100).toFixed(2) + '%';
                                        return params[0].data.name + ': ' + val + ' (' + percent + ')';
                                    }
                                },
                                grid: {
                                    top: 0,
                                    bottom: 15, 
                                    left: 20,
                                    right: 10,
                                    containLabel: false
                                },
                                xAxis: { show: false, type: 'value' },
                                yAxis: {
                                    type: 'category',
                                    data: [10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
                                    axisLine: { show: false },
                                    axisTick: { show: false },
                                    axisLabel: { show: true, interval: 0, color: '#666', fontSize: 8, margin: 5}
                                },
                                series: [{
                                    type: 'bar',
                                    data: top10End.map(item => ({ name: item.name, value: item.value })),
                                    barWidth: '85%', 
                                    itemStyle: { 
                                        color: '#37A2DA', 
                                        borderRadius: [0, 2, 2, 0] 
                                    },
                                    label: {show: false},
                                    emphasis: {
                                        disabled: false,
                                        scale: false,
                                        itemStyle: {
                                            color: '#2a82b3' 
                                        }
                                    }
                                }]
                            };
                            myChart4.setOption(option4);
                        </script>             
                    </th>
                    <!--5 miles -->
                    <th style="position: relative; width: 180px; height: 100px; padding: 0; vertical-align: top;">
                        <div id="main5" style="width: 100%; height: 100%;"></div>
                        <script type="text/javascript">
                            var myChart5 = echarts.init(document.getElementById('main5'));
                            var milesData = [
                                        {value: 496, name: '0-5 miles'},
                                        {value: 341, name: '5-10 miles'},
                                        {value: 234, name: '10-20 miles'},
                                        {value: 57, name: '20-50 miles'},
                                        {value: 27, name: '50+ miles'}];

                            var option5 = {
                                tooltip: {
                                    trigger: 'item',
                                    backgroundColor: 'rgba(50, 50, 50, 0.8)',
                                    textStyle: { color: '#fff', fontSize: 11 },
                                    confine: true,
                                    formatter: function(params) {
                                        var label = params.name.split(' ')[0]; 
                                        var formattedLabel = '[' + label.replace('-', ', ') + ')'; 
                                        return formattedLabel + ': ' + params.value + ' (' + params.percent + '%)';
                                    }
                                },
                                // --- 關鍵修正：調整 Grid 留白 ---
                                grid: {
                                    top: 5,      
                                    bottom: 5,
                                    left: 5,     // 左右各留 5px 的緩衝空間
                                    right: 8,    // 右邊稍微留多一點點給紅色區塊
                                    containLabel: false
                                },
                                series: [{
                                    name: 'Miles Distribution',
                                    type: 'pie',
                                    roseType: 'radius',
                                    radius: ['15%', '85%'], // 內徑與外徑，讓圖表更大
                                    center: ['50%', '55%'],
                                    avoidLabelOverlap: false,
                                    label: { show: false },
                                    itemStyle: {borderRadius: 4},
                                    emphasis: {focus: 'self', itemStyle: {shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0,0,0,0.5)', scaleSize: 8}
                                    },
                                    data: milesData
                                }]
                            };
                            myChart5.setOption(option5);
                        </script>
                    </th>
                    <!--6 purpose -->
                    <th style="position: relative; width: 160px; height: 100px; padding: 0; vertical-align: top;">
                            <div id="main6" style="width: 100%; height: 100%;"></div>
                            <script type="text/javascript">
                                var myChart6 = echarts.init(document.getElementById('main6'));
                                // 1. 資料定義
                                var purposeData = [
                                    {name: "Other", value: 502},
                                    {name: "Meeting", value: 187},
                                    {name: "Meal/Entertain", value: 160},
                                    {name: "Errand/Supplies", value: 128},
                                    {name: "Customer Visit", value: 101},
                                    {name: "Temporary Site", value: 50},
                                    {name: "Between Offices", value: 18},
                                    {name: "Moving", value: 4},
                                    {name: "Airport/Travel", value: 3},
                                    {name: "Charity", value: 1},
                                    {name: "Commute", value: 1}
                                ];

                                var totalPurpose = 1155;

                                // 2. 排序並取 Top 10
                                purposeData.sort((a, b) => b.value - a.value);
                                var top10 = purposeData.slice(0, 10);
                                
                                var option6 = {
                                    tooltip: {
                                        trigger: 'axis',
                                        backgroundColor: 'rgba(50, 50, 50, 0.8)',
                                        textStyle: { color: '#fff', fontSize: 11 },
                                        axisPointer: { type: 'none' },
                                        confine: true,
                                        formatter: function(params) {
                                            var i = params[0].dataIndex;
                                            var val = top10[i].value;
                                            var percent = ((val / totalPurpose) * 100).toFixed(2) + '%';
                                            return top10[i].name + ': ' + val + ' (' + percent + ')';
                                        },
                                    },
                                    grid: {
                                        top: 5,
                                        bottom: 18, // 留空間給 1-10 數字
                                        left: 2,
                                        right: 2,
                                        containLabel: false
                                    },
                                    xAxis: {
                                        type: 'category',
                                        data: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                                        axisLabel: {
                                            show: true,
                                            fontSize: 8,
                                            color: '#666',
                                            interval: 0,
                                            margin: 4
                                        },
                                        axisLine: { show: false },
                                        axisTick: { show: false }
                                    },
                                    yAxis: {
                                        show: false,
                                        type: 'value'
                                    },
                                    series: [{
                                        name: 'Purpose',
                                        type: 'bar',
                                        data: top10.map(item => item.value),
                                        barWidth: '85%',
                                        itemStyle: {
                                            color: '#37A2DA',
                                            borderRadius: [2, 2, 0, 0]
                                        },
                                        emphasis: {
                                            disabled: false,
                                            scale: false,
                                            itemStyle: {color: '#2a82b3'}
                                        }
                                    }]
                                };
                                myChart6.setOption(option6);
                            </script>
                    </th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            </table>

        </div>
    </div>
    <script>
        // --- 在這裡貼上您的 getDuration 函數 ---
        function getDuration(startStr, endStr) {
            var start = new Date(startStr);
            var end = new Date(endStr);
            var diffMin = Math.round((end - start) / (1000 * 60));
            return (isNaN(diffMin) || diffMin < 0) ? "-" : diffMin;
        }
        var config = {
            apiKey: "AIzaSyA1VQOAtkGbdNbpQKVD9hI0VYtBmRq6j8I",
            authDomain: "project551.firebaseapp.com",
            databaseURL: "https://project551.firebaseio.com",
            projectId: "project551",
            storageBucket: "project551.appspot.com",
            messagingSenderId: "227141625715",
            appId: "1:227141625715:web:a12885fbb115acf6fd8706",
            measurementId: "G-S6YXCTHX32"
        };
        firebase.initializeApp(config);
        // Get a reference to the database service
        var database = firebase.database();
        var myuber = database.ref('/index/');
        var djson;

        myuber.once('value', function(snapshot){
            var rawData = snapshot.val();
            djson = jsonToArray(rawData);
            renderTable(djson);
        });
    </script>
    <script>
    //done
    function default_() {
        // 1. 回復 Miles 輸入框的顯示數值
        document.getElementById("small_").value = 0;
        document.getElementById("big_").value = 500;
    
        // 2. 回復 Purpose 下拉選單的顯示文字
        var selectedText = document.getElementById('selected_purpose_text');
        if (selectedText) {
            selectedText.innerHTML = "Select Purpose";
        }
    
        // 3. 清空隱藏的搜尋數值 (search_item_2)
        var hiddenInput = document.getElementById("search_item_2");
        if (hiddenInput) {
            hiddenInput.value = "";
        }
    
        // 4. 執行原有的資料重載邏輯
        var index_ = database.ref('/index');
        index_.once('value', function(snapshot) {
            var rawData = snapshot.val();
            var djson = jsonToArray(rawData);
            renderTable(djson);
        });
    }

    // #升序
    function up_compare(property){
        return function(obj1, obj2) {
            var value1 = obj1[property];
            var value2 = obj2[property];
            return value1 - value2;
        }
        // var sortObj = infoObj.sort(compare())
    }
    // #降序
    function down_compare(property){
        return function(obj1, obj2) {
            var value1 = obj1[property];
            var value2 = obj2[property];
            return value2 - value1;
        }
    }

    // 字典跟array的exchange
    function jsonToArray (obj) {
        const result = [];
        for (let key in obj) {
            result.push(obj[key]);
        }
        return result;
    }

    //done
    function mile_sort_up(){
        var database = firebase.database();
        var mile_ = database.ref('/index').orderByChild('MILES');

        mile_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            var djson = jsonToArray(djson_raw);
            djson.sort(up_compare("MILES"));
            renderTable(djson);
        });
    }
    //done
    function mile_sort_down(){
        var mile_ = database.ref('/index/').orderByChild('MILES');
        var djson;

        mile_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(down_compare("MILES"));
            renderTable(djson);
        });
    }

    //done
    function up_date(property){
        return function(obj1, obj2) {
            var v1 = new Date(obj1[property]);
            var v2 = new Date(obj2[property]);
            return v1 - v2;
        }
    }
    //done
    function down_date(property){
        return function(obj1, obj2) {
            var v1 = new Date(obj1[property]);
            var v2 = new Date(obj2[property]);
            return v2 - v1;
        }
    }
    //done
    function startdate_sort_up(){
        var mile_ = database.ref('/index').orderByChild('START_DATE');
        var djson;
        
        mile_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(up_date("START_DATE"));
            renderTable(djson);
        });
    }
    //done
    function startdate_sort_down(){
        var database = firebase.database();
        var myuber = database.ref('/index/').orderByChild('START_DATE');
        var djson;

        myuber.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(down_date("START_DATE"));
            renderTable(djson);
        });
    }

    //done
    function catalog_sort_up(){
        var catalog_ = database.ref('/index').orderByChild('CATEGORY');
        var djson;

        catalog_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(up_string("CATEGORY"));
            renderTable(djson);
        });
    }
    //done
    function catalog_sort_down(){
        var catalog_ = database.ref('/index').orderByChild('CATEGORY');
        var djson;

        catalog_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(down_string("CATEGORY"));
            renderTable(djson);
        });
    }
        
    //done
    function duration_sort_up() {
    var rf = database.ref('/index'); 
    rf.once('value', function(snapshot) {
        var djson = jsonToArray(snapshot.val());
        djson.sort(up_duration_compare());
        renderTable(djson); 
        });
    }

    function duration_sort_down() {
        var rf = database.ref('/index');
        rf.once('value', function(snapshot) {
            var djson = jsonToArray(snapshot.val());
            djson.sort(down_duration_compare());
            renderTable(djson);
        });
    }
    
    function renderTable(dataArray) {
        var tr = "";
        for (var i = 0; i < dataArray.length; i++) {
            if (dataArray[i] != null) {
                tr += "<tr>";
                tr += "<td>" + (i + 1) + "</td>";
                tr += "<td>" + dataArray[i]["START_DATE"] + "</td>";
                tr += "<td>" + getDuration(dataArray[i]["START_DATE"], dataArray[i]["END_DATE"]) + "</td>";
                tr += "<td>" + dataArray[i]["CATEGORY"] + "</td>";
                tr += "<td>" + dataArray[i]["START"] + "</td>";
                tr += "<td>" + dataArray[i]["STOP"] + "</td>";
                tr += "<td>" + dataArray[i]["MILES"] + "</td>";
                tr += "<td>" + dataArray[i]["PURPOSE"] + "</td>";
                tr += "</tr>";
            }
        }
        document.querySelector("table tbody").innerHTML = tr;
    }
        
    function up_string(property){
        return function(obj1, obj2) {
            var value1 = obj1[property];
            var value2 = obj2[property];
            return (value1 > value2)?1:-1;
        }
    }
    function down_string(property){
        return function(obj1, obj2) {
            var value1 = obj1[property];
            var value2 = obj2[property];
            return (value2 > value1)?1:-1;
        }
    }

    function up_duration_compare() {
        return function(obj1, obj2) {
            var val1 = parseFloat(getDuration(obj1["START_DATE"], obj1["END_DATE"])) || 0;
            var val2 = parseFloat(getDuration(obj2["START_DATE"], obj2["END_DATE"])) || 0;
            return val1 - val2;
        };
    }
    
    function down_duration_compare() {
        return function(obj1, obj2) {
            var val1 = parseFloat(getDuration(obj1["START_DATE"], obj1["END_DATE"])) || 0;
            var val2 = parseFloat(getDuration(obj2["START_DATE"], obj2["END_DATE"])) || 0;
            return val2 - val1;
        };
    }

    //done
    function purpose_sort_up(){
        var purpose_ = database.ref('/index').orderByChild('PURPOSE');
        var djson;

        purpose_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(up_string("PURPOSE"));

            var tr = "";
            for(var i = 0; i < djson.length; i++){
               if(djson[i] != null){
                    tr += "<tr>";
                    tr += "<td>"+(i + 1)+"</td>";
                    tr += "<td>"+djson[i]["START_DATE"]+"</td>";
                    tr += "<td>" + getDuration(djson[i]["START_DATE"], djson[i]["END_DATE"]) + "</td>";
                    tr += "<td>"+djson[i]["CATEGORY"]+"</td>";
                    tr += "<td>"+djson[i]["START"]+"</td>";
                    tr += "<td>"+djson[i]["STOP"]+"</td>";
                    tr += "<td>"+djson[i]["MILES"]+"</td>";
                    tr += "<td>"+djson[i]["PURPOSE"]+"</td>";
                    tr += "</tr>";
                }    
            }
            document.querySelector("table tbody").innerHTML = tr;
        });
    } 
    //done
    function purpose_sort_down(){
        var purpose_ = database.ref('/index').orderByChild('PURPOSE');
        var djson;

        purpose_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(down_string("PURPOSE"));
            
            var tr = "";
            for(var i = 0; i < djson.length; i++){ 
                if(djson[i] != null){
                    tr += "<tr>";
                    tr += "<td>"+(i + 1)+"</td>"; // 排序後的序號
                    tr += "<td>"+djson[i]["START_DATE"]+"</td>";
                    tr += "<td>" + getDuration(djson[i]["START_DATE"], djson[i]["END_DATE"]) + "</td>";
                    tr += "<td>"+djson[i]["CATEGORY"]+"</td>";
                    tr += "<td>"+djson[i]["START"]+"</td>";
                    tr += "<td>"+djson[i]["STOP"]+"</td>";
                    tr += "<td>"+djson[i]["MILES"]+"</td>";
                    tr += "<td>"+djson[i]["PURPOSE"]+"</td>";
                    tr += "</tr>";
                }    
            }
            document.querySelector("table tbody").innerHTML = tr;
        });
    } 
    //done
    function start_sort_up(){
        var purpose_ = database.ref('/index/').orderByChild('START');
        var djson;

        purpose_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(up_string("START"));
            renderTable(djson);
        });
    } 
    //done
    function start_sort_down(){
        var purpose_ = database.ref('/index/').orderByChild('START');
        var djson;

        purpose_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(down_string("START"));
            renderTable(djson);
        });
    }

    //done
    function destination_sort_up(){
        var purpose_ = database.ref('/index/').orderByChild('STOP');
        var djson;

        purpose_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(up_string("STOP"));
            renderTable(djson);
        });
    } 
    //done
    function destination_sort_down(){
        var purpose_ = database.ref('/index/').orderByChild('STOP');
        var djson;

        purpose_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            djson.sort(down_string("STOP"));
            renderTable(djson);
        });
    } 

    function search_catalogy(){
        var srearchItem = document.getElementById("search_item_1").value;
        var purpose_ = database.ref('/index').orderByChild('CATEGORY').equalTo(srearchItem);
        var djson;

        purpose_.once('value', function(snapshot){
            var djson_raw = snapshot.val();
            djson = jsonToArray(djson_raw);
            renderTable(djson);
        });
    }
    //done
    function search_purpose() {
        // 1. 獲取當前選中的 Purpose
        var searchItem = document.getElementById("search_item_2").value;
        // 2. 獲取當前 Miles 的範圍
        var small_ = parseFloat(document.getElementById("small_").value) || 0;
        var big_ = parseFloat(document.getElementById("big_").value) || 99999;
    
        // 如果沒選 Purpose，就視同執行 Miles Filter
        if (searchItem === "") {
            range_(); 
            return;
        }

        var purpose_ = database.ref('/index').orderByChild('PURPOSE').equalTo(searchItem);
    
        purpose_.once('value', function(snapshot) {
            var djson_raw = snapshot.val();
            var djson = jsonToArray(djson_raw);
            var tr = "";
            var displayCount = 1;
            
            for (var i = 0; i < djson.length; i++) {
                if (djson[i] != null) {
                    // --- 關鍵修改：在這裡同時判斷 Miles 範圍 ---
                    var miles = parseFloat(djson[i]["MILES"]);
                    if (miles >= small_ && miles <= big_) {
                        tr += "<tr>";
                        tr += "<td>" + displayCount + "</td>";
                        tr += "<td>" + djson[i]["START_DATE"] + "</td>";
                        tr += "<td>" + getDuration(djson[i]["START_DATE"], djson[i]["END_DATE"]) + "</td>";
                        tr += "<td>" + djson[i]["CATEGORY"] + "</td>";
                        tr += "<td>" + djson[i]["START"] + "</td>";
                        tr += "<td>" + djson[i]["STOP"] + "</td>";
                        tr += "<td>" + djson[i]["MILES"] + "</td>";
                        tr += "<td>" + djson[i]["PURPOSE"] + "</td>";
                        tr += "</tr>";
                        displayCount++;
                    }
                }
            }
            document.querySelector("table tbody").innerHTML = tr;
        });
    }

    function range_() {
        var small_ = parseFloat(document.getElementById("small_").value) || 0;
        var big_ = parseFloat(document.getElementById("big_").value) || 99999;
        // 獲取當前選單的值
        var currentPurpose = document.getElementById("search_item_2").value;
    
        var range_val = database.ref('/index');
        range_val.once('value', function(snapshot) {
            var djson_raw = snapshot.val();
            var djson = jsonToArray(djson_raw);
            
            var tr = "";
            var displayCount = 1; // 用來顯示正確的表格序號

            for (var i = 0; i < djson.length; i++) {
                if (djson[i] != null) {
                    var miles = parseFloat(djson[i]["MILES"]);
                    var purpose = djson[i]["PURPOSE"];
    
                    // --- 同時判斷 Miles 和 Purpose ---
                    var matchMiles = (miles >= small_ && miles <= big_);
                    var matchPurpose = (currentPurpose === "" || purpose === currentPurpose);
    
                    if (matchMiles && matchPurpose) {
                        tr += "<tr>";
                        tr += "<td>" + displayCount + "</td>";
                        tr += "<td>" + djson[i]["START_DATE"] + "</td>";
                        tr += "<td>" + getDuration(djson[i]["START_DATE"], djson[i]["END_DATE"]) + "</td>";
                        tr += "<td>" + djson[i]["CATEGORY"] + "</td>";
                        tr += "<td>" + djson[i]["START"] + "</td>";
                        tr += "<td>" + djson[i]["STOP"] + "</td>";
                        tr += "<td>" + djson[i]["MILES"] + "</td>";
                        tr += "<td>" + djson[i]["PURPOSE"] + "</td>";
                        tr += "</tr>";
                        displayCount++; // 符合條件才增加序號
                    }
                }
            }
            document.querySelector("table tbody").innerHTML = tr;
        });
    }
    </script>

    <script>
    // 1. 當網頁載入完成後，自動把選項塞進下拉選單
    window.addEventListener('load', function() {
        var purposes = [
            "Other", "Meeting", "Meal/Entertain", "Errand/Supplies", 
            "Customer Visit", "Temporary Site", "Between Offices", 
            "Moving", "Airport/Travel", "Charity", "Commute"
        ];

        var listContainer = document.getElementById('purpose_list');
        if (listContainer) {
            purposes.forEach(function(item) {
                var li = document.createElement('li');
                var a = document.createElement('a');
                a.href = "javascript:void(0)";
                a.innerHTML = item;
                // 點擊選項時執行 selectPurpose 函數
                a.onclick = function() { selectPurpose(item); };
                li.appendChild(a);
                listContainer.appendChild(li);
            });
        }
    });

    // 2. 定義點擊選項後的動作
    function selectPurpose(val) {
        // 更新按鈕文字
        document.getElementById('selected_purpose_text').innerHTML = val ? val : "Select Purpose";
        // 把值存入隱藏的 input，讓 Firebase 邏輯能抓到
        document.getElementById('search_item_2').value = val;
        
        // 觸發搜尋
        if (val === "") {
            default_(); 
        } else {
            search_purpose(); 
        }
    }

    // 3. 原有的視窗縮放邏輯
    window.addEventListener('resize', function() {
        if (typeof myChart !== 'undefined') myChart.resize();
        if (typeof myChart1 !== 'undefined') myChart1.resize();
        if (typeof myChart2 !== 'undefined') myChart2.resize();
        if (typeof myChart4 !== 'undefined') myChart4.resize();
        if (typeof myChart5 !== 'undefined') myChart5.resize();
        if (typeof myChart6 !== 'undefined') myChart6.resize();
    });
    </script>


</body>
</html>


